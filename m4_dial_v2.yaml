esphome:
  name: m4dial
  friendly_name: M4Dial
  on_boot:
    then:
     # read the RTC time once when the system boots
      - pcf8563.read_time: my_time
      - light.turn_on: backlight
      - text_sensor.template.publish:
          id: template_text
          state: !lambda |-
              char str[17];
              time_t currTime = id(my_time).now().timestamp;
              strftime(str, sizeof(str), "%Y-%M-%d %H:%M", localtime(&currTime));
              return  { str };

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: arduino

# Enable logging
logger:
  level: DEBUG

api:
  encryption:
    key: !secret m4dialencryption

ota:
  password: !secret m4dialotapassword

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "M5Dial Fallback Hotspot"
    password: !secret m4fallbackpassword

captive_portal:

globals:
  - id: encoder_value
    type: int
    initial_value: '0'
    restore_value: yes
  - id: light_encoder_resolution
    type: int
    initial_value: '4'
    restore_value: yes  
  - id: climate_encoder_resolution
    type: int
    initial_value: '4'
    restore_value: yes  
  - id: rf_code_queue
    type: 'std::vector<std::string>'

script:
  - id: my_light_brightness_script
    mode: restart
    then:
      - delay: 1200ms
      - homeassistant.service:
          service: light.turn_on
          data_template:
            entity_id: light.great_room_dimmer_4
            brightness: !lambda 'return id(new_light_brightness).state;'

  - id: my_climate_temperature_script
    mode: restart
    then:
      - delay: 1200ms
      - homeassistant.service:
          service: climate.set_temperature
          data_template:
            entity_id: climate.doris
            temperature: !lambda return (id(temperature_new_setpoint).state);

external_components:
  - source: github://dgaust/esphome@gc9a01
    components: [ ft3267 ]
    refresh: 0s

i2c:
  - id: bus_internal
    sda: GPIO11
    scl: GPIO12
    scan: False

touchscreen:
  platform: ft3267

time:
  - platform: pcf8563
    id: my_time
    address: 0x51
    update_interval: never
  - platform: homeassistant
    on_time_sync:
      then:
        - pcf8563.write_time: my_time
        - text_sensor.template.publish:
            id: template_text
            state: !lambda |-
              char str[17];
              time_t currTime = id(my_time).now().timestamp;
              strftime(str, sizeof(str), "%Y-%m-%d %H:%M", localtime(&currTime));
              return  { str };

rc522_i2c:
  i2c_id:  bus_internal
  address: 0x28
  on_tag:
    then:
      - rtttl.play: "success:d=24,o=5,b=100:c,g,b"
      - homeassistant.tag_scanned: !lambda 'return x;'

rtttl:
  output: my_speaker_output
  id: my_rtttl

color:
  - id: my_white
    hex: 'FFFFFF'
  - id: black
    hex: '000000'
  - id: dark_green
    hex: '013208'
  - id: my_red
    red: 100%
    green: 3%
    blue: 5%
  - id: my_green
    hex: 59981A
  - id: my_blue
    red: 3%
    green: 5%
    blue: 100%
  - id: my_yellow
    hex: FFFF00 
  - id: my_light_blue
    hex: 145DA0
  - id: my_light_red
    hex: fc6d6d
  - id: my_dark_red
    hex: 8B0000
  - id: my_light_orange
    hex: FD7F20
  - id: my_orange
    hex: FF5733
  - id: my_light_yellow
    hex: B58B00
  - id: dark_blue
    hex: '000040'
  - id: dark_red
    hex: '67091C'
  - id: dark_grey
    hex: '161616'
  - id: very_dark_grey
    hex: '101111'
  - id: very_dark_blue
    hex: '0C355C'
  - id: my_light_grey
    hex: '949494'

image:
  - id: networkQR
    file: images/m4dial/My_WiFi_QR_Code.png
    resize: 160x160
  - id: background
    file: images/m4dial/background.png
    type: RGBA
  - id: switch_animated
    file: images/m4dial/switch.gif
    resize: 240x240
  - id: volume_mute
    file: mdi:volume-variant-off
    resize: 40x40
  - id: volume_notmute
    file: mdi:volume-low
    resize: 40x40
  - id: downlighticon
    file: mdi:light-recessed
    resize: 80x80
  - id: airconicon
    file: mdi:air-conditioner
    resize: 80X80
  - id: ac_cool_40
    file: mdi:snowflake
    resize: 30x30
  - id: ac_heatcool_40
    file: mdi:sun-snowflake-variant
    resize: 30x30
  - id: ac_fan_40
    file: mdi:fan
    resize: 30x30
  - id: power_off_icon_40
    file: mdi:power-cycle
    resize: 40x40
  - id: ac_dry_40
    file: mdi:water-percent
    resize: 30x30
  - id: ac_heat_40
    file: mdi:fire
    resize: 30x30
  - id: temp_target_icon
    file: mdi:thermometer
    resize: 20x20
  - id: temp_current_icon
    file: mdi:bullseye
    resize: 20x20
  - id: ac_cool_80
    file: mdi:snowflake
    resize: 80x80
  - id: ac_heatcool_80
    file: mdi:sun-snowflake-variant
    resize: 80x80
  - id: ac_fan_80
    file: mdi:fan
    resize: 80x80
  - id: power_off_icon_80
    file: mdi:power-cycle
    resize: 80x80
  - id: ac_dry_80
    file: mdi:water-percent
    resize: 80x80
  - id: ac_heat_80
    file: mdi:fire
    resize: 80x80
  - id: volumeknob
    file: mdi:knob
    resize: 80x80
  - id: infoicon
    file: mdi:information
    resize: 40x40
  - id: zoneicon
    file: mdi:air-filter
    resize: 25x25
  - id: volumeknob_60
    file: mdi:knob
    resize: 60x60
  - id: airconicon_60
    file: mdi:air-conditioner
    resize: 50X50
  - id: downlighticon_60
    file: mdi:light-recessed
    resize: 60x60
  - id: downlighticon_menu_icon
    file: mdi:light-recessed
    resize: 30x30
  - id: fan_menu_icon
    file: mdi:fan
    resize: 30x30
  - id: audio_menu_icon
    file: mdi:knob
    resize: 30x30
  - id: threed_printer_menu_icon
    file: mdi:printer-3d-nozzle
    resize: 30x30
  - id: tv_menu_icon
    file: mdi:television
    resize: 30x30
  - id: alarm_menu_icon
    file: mdi:alarm-light
    resize: 30x30
  - id: settings_menu_icon
    file: mdi:cog
    resize: 30x30
  - id: powercycle
    file: mdi:power-cycle
    resize: 30x30
  - id: wifi_menu_item
    file: mdi:wifi-sync
    resize: 30x30


animation:
  - id: my_animation
    file: images/m4dial/switch.gif
    resize: 100x100
    use_transparency: True

font:
  - id: roboto16
    file: "gfonts://Roboto"
    size: 16

  - id: roboto20
    file: "gfonts://Roboto"
    size: 20
  
  - id: roboto24
    file: "gfonts://Roboto"   
    size: 24

uart:
  tx_pin: GPIO2
  rx_pin: GPIO1
  baud_rate: 256000
  parity: NONE
  stop_bits: 1

ld2410:

spi:
  mosi_pin: GPIO5
  clk_pin: GPIO6

number:
  - platform: template
    id: new_light_brightness
    initial_value: 0
    min_value: 0
    max_value: 255
    step: 1
    optimistic: true  

  - platform: template
    id: temperature_new_setpoint
    initial_value: 0
    min_value: 7
    max_value: 31
    step: 1
    optimistic: true

  - platform: template
    id: temperature_current_template
    initial_value: 0
    min_value: 7
    max_value: 31
    step: 1
    optimistic: true
    
  - platform: template
    id: pi
    internal: true
    optimistic: true
    min_value: 3.14159265359
    max_value: 3.14159265360
    step: 0.00000000001
    initial_value: 3.14159265359

  - platform: template
    id: climate_icon_distance_radius
    internal: true
    optimistic: true
    min_value: 0
    max_value: 1
    step: 0.01
    initial_value: 0.6

  - platform: template
    id: climate_icon_separation_angle
    internal: true
    optimistic: true
    min_value: 30
    max_value: 60
    step: 1
    initial_value: 55

  - platform: template
    id: climate_bottom_gauge_angle
    internal: true
    optimistic: true
    min_value: 30
    max_value: 180
    step: 1
    initial_value: 70

  - platform: template
    id: climate_temperature_distance_from_center
    internal: true
    optimistic: true
    min_value: 0
    max_value: 40
    step: 1
    initial_value: 20

display:
- platform: ili9xxx
  model: gc9a01a
  reset_pin: GPIO8
  id: my_lcd
  cs_pin: GPIO7
  dc_pin: GPIO4
  dimensions: 
    height: 240
    width: 240
  pages:
    - id: TestPage
      lambda: |- 
        Color bground_ac = id(very_dark_blue);
        Color default_circle_color = id (very_dark_blue);
        Color centre_circle_color = id (my_light_blue);

        if (id(climatedevice).state == "cool")
        {
          // cooling
          bground_ac = my_light_blue;
        }
        else if (id(climatedevice).state == "heat")
        {
          // heating
          bground_ac = my_light_red;
        }
        else if (id(climatedevice).state == "auto")
        {
          bground_ac = my_light_orange;
        }
        else if (id(climatedevice).state == "fan_only")
        {
           bground_ac = my_light_orange;
        }
        else if (id(climatedevice).state == "dry")
        {
          // dry
          bground_ac = my_green;
        }
        it.image(120, 120, background, ImageAlign::CENTER);
        it.filled_circle(120, 120, 30, centre_circle_color);  // Central Circle
        it.image(120, 120, downlighticon_menu_icon, ImageAlign::CENTER);
        
        it.filled_circle(190, 120, 30, default_circle_color);  // Circle 2
        it.image(190, 120, settings_menu_icon, ImageAlign::CENTER);

        it.filled_circle(155, 181, 30, default_circle_color);  // Circle 3
        it.image(155, 181, wifi_menu_item, ImageAlign::CENTER);
        
        it.filled_circle(85, 181, 30, default_circle_color);  // Circle 4
        it.image(85, 181, tv_menu_icon, ImageAlign::CENTER);

        it.filled_circle(50, 120, 30, default_circle_color);  // Circle 5
        it.image(50, 120, alarm_menu_icon, ImageAlign::CENTER);

        it.filled_circle(85, 59, 30, bground_ac);   // Circle 6
        it.image(85, 59, fan_menu_icon, ImageAlign::CENTER);
       
        it.filled_circle(155, 59, 30, default_circle_color); // Circle 7     
        it.image(155, 59, audio_menu_icon, ImageAlign::CENTER);  
    - id: FirstPage
      lambda: |-
        float screenheight = it.get_height();
        float screenwidth = it.get_width();
        float halfscreenheight = screenheight / 2;
        float halfscreenwidth = screenwidth / 2;

        it.image(120, 120, background, ImageAlign::CENTER);
        int centerX = 120;  // X-coordinate of the circle center
        int centerY = 120;  // Y-coordinate of the circle center

        float currentLightCircleAngle = (360 - id(climate_bottom_gauge_angle).state) * (id(new_light_brightness).state / 255);
        float targetLightCircleAngle = (360 - id(climate_bottom_gauge_angle).state) * (id(dimmersensor_brightness).state / 255);
          
        float startAngle = id(climate_bottom_gauge_angle).state / 2;
        float firstStepAngle = (currentLightCircleAngle < targetLightCircleAngle) ? currentLightCircleAngle : targetLightCircleAngle;
        float secondStepAngle = (currentLightCircleAngle > targetLightCircleAngle) ? firstStepAngle : targetLightCircleAngle;
        float endAngle = 360 - id(climate_bottom_gauge_angle).state;

        // Display temperature arc circle
        it
          .filled_circle(
            halfscreenwidth + (halfscreenwidth - 10) * cos((90 + startAngle) * id(pi).state / 180),
            halfscreenheight + (halfscreenheight - 10) * sin((90 + startAngle) * id(pi).state / 180), 
            5, 
            id(my_light_orange));
        it
          .filled_circle(
            halfscreenwidth + (halfscreenwidth - 10) * cos((90 + startAngle + endAngle) * id(pi).state / 180),
            halfscreenheight + (halfscreenheight - 10) * sin((90 + startAngle + endAngle) * id(pi).state / 180), 
            5, 
            id(very_dark_grey));


        for (int i = startAngle; i <= startAngle + firstStepAngle; i++) {
            it
              .filled_triangle(
                halfscreenwidth + (halfscreenwidth - 15) * cos((90 + i) * id(pi).state / 180),
                halfscreenheight + (halfscreenheight - 15) * sin((90 + i) * id(pi).state / 180), 
                halfscreenwidth + (halfscreenwidth - 5) * cos((90 + i) * id(pi).state / 180), 
                halfscreenheight + (halfscreenheight - 5) * sin((90 + i) * id(pi).state / 180), 
                halfscreenwidth + (halfscreenwidth - 5) * cos((90 + (i + 1)) * id(pi).state / 180), 
                halfscreenheight + (halfscreenheight - 5) * sin((90 + (i + 1)) * id(pi).state / 180), 
                id(my_light_yellow));
            it
              .filled_triangle(
                halfscreenwidth + (halfscreenwidth - 15) * cos((90 + i) * id(pi).state / 180),
                halfscreenheight + (halfscreenheight - 15) * sin((90 + i) * id(pi).state / 180), 
                halfscreenwidth + (halfscreenwidth - 5) * cos((90 + (i + 1)) * id(pi).state / 180), 
                halfscreenheight + (halfscreenheight - 5) * sin((90 + (i + 1)) * id(pi).state / 180), 
                halfscreenwidth + (halfscreenwidth - 15) * cos((90 + (i + 1)) * id(pi).state / 180),
                halfscreenheight + (halfscreenheight - 15) * sin((90 + (i + 1)) * id(pi).state / 180), 
                id(my_light_yellow));
          }

         for (int i = startAngle + firstStepAngle; i <= startAngle + secondStepAngle; i++) {
            it
              .filled_triangle(
                halfscreenwidth + (halfscreenwidth - 15) * cos((90 + i) * id(pi).state / 180),
                halfscreenheight + (halfscreenheight - 15) * sin((90 + i) * id(pi).state / 180), 
                halfscreenwidth + (halfscreenwidth - 5) * cos((90 + i) * id(pi).state / 180), 
                halfscreenheight + (halfscreenheight - 5) * sin((90 + i) * id(pi).state / 180), 
                halfscreenwidth + (halfscreenwidth - 5) * cos((90 + (i + 1)) * id(pi).state / 180), 
                halfscreenheight + (halfscreenheight - 5) * sin((90 + (i + 1)) * id(pi).state / 180), 
                id(my_light_grey));
            it
              .filled_triangle(
                halfscreenwidth + (halfscreenwidth - 15) * cos((90 + i) * id(pi).state / 180),
                halfscreenheight + (halfscreenheight - 15) * sin((90 + i) * id(pi).state / 180), 
                halfscreenwidth + (halfscreenwidth - 5) * cos((90 + (i + 1)) * id(pi).state / 180), 
                halfscreenheight + (halfscreenheight - 5) * sin((90 + (i + 1)) * id(pi).state / 180), 
                halfscreenwidth + (halfscreenwidth - 15) * cos((90 + (i + 1)) * id(pi).state / 180),
                halfscreenheight + (halfscreenheight - 15) * sin((90 + (i + 1)) * id(pi).state / 180), 
                id(my_light_grey));
          }
          for (int i = startAngle + secondStepAngle; i <= startAngle + endAngle; i++) {
            it
              .filled_triangle(
                halfscreenwidth + (halfscreenwidth - 15) * cos((90 + i) * id(pi).state / 180),
                halfscreenheight + (halfscreenheight - 15) * sin((90 + i) * id(pi).state / 180), 
                halfscreenwidth + (halfscreenwidth - 5) * cos((90 + i) * id(pi).state / 180), 
                halfscreenheight + (halfscreenheight - 5) * sin((90 + i) * id(pi).state / 180), 
                halfscreenwidth + (halfscreenwidth - 5) * cos((90 + (i + 1)) * id(pi).state / 180), 
                halfscreenheight + (halfscreenheight - 5) * sin((90 + (i + 1)) * id(pi).state / 180), 
                id(very_dark_grey));
            it
              .filled_triangle(
                halfscreenwidth + (halfscreenwidth - 15) * cos((90 + i) * id(pi).state / 180),
                halfscreenheight + (halfscreenheight - 15) * sin((90 + i) * id(pi).state / 180), 
                halfscreenwidth + (halfscreenwidth - 5) * cos((90 + (i + 1)) * id(pi).state / 180), 
                halfscreenheight + (halfscreenheight - 5) * sin((90 + (i + 1)) * id(pi).state / 180), 
                halfscreenwidth + (halfscreenwidth - 15) * cos((90 + (i + 1)) * id(pi).state / 180),
                halfscreenheight + (halfscreenheight - 15) * sin((90 + (i + 1)) * id(pi).state / 180), 
                id(very_dark_grey));
          }
        
        // Current temperature round
          it
            .filled_circle(
              halfscreenwidth + (halfscreenwidth - 10) * cos((90 + startAngle + currentLightCircleAngle) * id(pi).state / 180),
              halfscreenheight + (halfscreenheight - 10) * sin((90 + startAngle + currentLightCircleAngle) * id(pi).state / 180), 
              3, 
              id(my_white));

          // Start of the second step
          if (firstStepAngle < secondStepAngle) {
            it
              .filled_circle(
                halfscreenwidth + (halfscreenwidth - 10) * cos((90 + startAngle + firstStepAngle) * id(pi).state / 180),
                halfscreenheight + (halfscreenheight - 10) * sin((90 + startAngle + firstStepAngle) * id(pi).state / 180), 
                5, 
                id(my_white));
            it
              .filled_circle(
                halfscreenwidth + (halfscreenwidth - 10) * cos((90 + startAngle + firstStepAngle) * id(pi).state / 180),
                halfscreenheight + (halfscreenheight - 10) * sin((90 + startAngle + firstStepAngle) * id(pi).state / 180), 
                2, 
                id(very_dark_grey));
          } 

        it.printf(halfscreenwidth, halfscreenheight, id(roboto24), TextAlign::CENTER, "%d%%", map(id(new_light_brightness).state, 0, 255, 0, 100));
        it.filled_circle(120, 200, 30, very_dark_grey);  // Central Circle
        it.image(120, 200, powercycle, ImageAlign::CENTER);
    - id: WifiQR
      lambda: |-
        // Draw the QR-code at position [x=50,y=0] with white color and a 2x scale
        it.image(120, 120, networkQR, ImageAlign::CENTER);
        it.printf(120, 200, id(roboto20), TextAlign::CENTER, "Password: 26Doris");
    - id: AirConPage
      lambda: |-
          // Variables
          float screenheight = it.get_height();
          float screenwidth = it.get_width();
          float halfscreenheight = screenheight / 2;
          float halfscreenwidth = screenwidth / 2;

          // float currentTemperatureCircleAngle = (360 - id(climate_bottom_gauge_angle).state) * ((id(climatedevice_currenttemp).state - id(climate_min_temperature).state) / (id(climate_max_temperature).state - id(climate_min_temperature).state));
          float currentTemperatureCircleAngle = (360 - id(climate_bottom_gauge_angle).state) * ((id(climatedevice_currenttemp).state - id(climate_min_temperature).state) / (id(climate_max_temperature).state - id(climate_min_temperature).state));
          
          // float targetTemperatureCircleAngle = (360 - id(climate_bottom_gauge_angle).state) * ((id(climatedevice_setpoint).state - id(climate_min_temperature).state) / (id(climate_max_temperature).state - id(climate_min_temperature).state));
          float targetTemperatureCircleAngle = (360 - id(climate_bottom_gauge_angle).state) * ((id(temperature_new_setpoint).state - id(climate_min_temperature).state) / (id(climate_max_temperature).state - id(climate_min_temperature).state));
          
          float startAngle = id(climate_bottom_gauge_angle).state / 2;
          float firstStepAngle = (currentTemperatureCircleAngle < targetTemperatureCircleAngle) ? currentTemperatureCircleAngle : targetTemperatureCircleAngle;
          float secondStepAngle = (currentTemperatureCircleAngle > targetTemperatureCircleAngle) ? firstStepAngle : targetTemperatureCircleAngle;
          float endAngle = 360 - id(climate_bottom_gauge_angle).state;

          it.image(120, 120, background, ImageAlign::CENTER);
          if (id(climatedevice).state == "cool")
          {
            // cooling
            it.filled_circle(halfscreenwidth, halfscreenheight, 120, my_light_blue);
            it.image(halfscreenwidth, halfscreenheight + -55, ac_cool_80, ImageAlign::TOP_CENTER); 
          }
          else if (id(climatedevice).state == "heat")
          {
            // heating
            it.filled_circle(halfscreenwidth, halfscreenheight, 120, my_light_red);
            it.image(halfscreenwidth, halfscreenheight + -55, ac_heat_80, ImageAlign::TOP_CENTER);
          }
          else if (id(climatedevice).state == "auto")
          {
            // auto heat or cool
            it.filled_circle(halfscreenwidth, halfscreenheight, 120, my_light_orange);
            it.image(halfscreenwidth, halfscreenheight + -55, ac_heatcool_80, ImageAlign::TOP_CENTER);
          }
          else if (id(climatedevice).state == "fan_only")
          {
            // fan only
            it.filled_circle(halfscreenwidth, halfscreenheight, 120, my_light_orange);
            it.image(halfscreenwidth, halfscreenheight + -55, ac_fan_80, ImageAlign::TOP_CENTER);
          }
          else if (id(climatedevice).state == "dry")
          {
            // dry
            it.filled_circle(halfscreenwidth, halfscreenheight, 120, my_green);
            // it.image(halfscreenwidth - 80, halfscreenheight - 20, ac_dry_40, ImageAlign::TOP_CENTER);
            it.image(halfscreenwidth, halfscreenheight + -55, ac_dry_80, ImageAlign::TOP_CENTER);
          }
          else if (id(climatedevice).state == "off")
          {
            // off
            it.image(halfscreenwidth, halfscreenheight - 55, power_off_icon_80, ImageAlign::TOP_CENTER);
          }

          it.printf(halfscreenwidth, halfscreenheight - 90, id(roboto24), TextAlign::TOP_CENTER, "Air-Con");
          // it.printf(halfscreenwidth + 10, halfscreenheight + 15, id(roboto24), TextAlign::TOP_CENTER, "%.0f", id(temperature_new).state); 
          it.printf(halfscreenwidth + 10, halfscreenheight + 35, id(roboto24), TextAlign::TOP_CENTER, "%.0f", id(temperature_new_setpoint).state); 
          it.printf(halfscreenwidth + 10, halfscreenheight + 65, id(roboto24), TextAlign::TOP_CENTER, "%.0f", id(climate_current_temperature).state); 
        
          if (id(climatedevice).state != "off")
          {
            it.image(halfscreenwidth - 75, halfscreenheight - 15, zoneicon, ImageAlign::TOP_CENTER);
            it.printf(halfscreenwidth - 55, halfscreenheight -13, id(roboto20), TextAlign::TOP_CENTER, "%s", id(zones_open).state.c_str()); 
          }
        
          it.line(halfscreenwidth - 40, halfscreenheight + 65, it.get_width() / 2 + 40, it.get_height() / 2 + 65);
          it.image(halfscreenwidth - 30, halfscreenheight + 40, temp_current_icon, ImageAlign::TOP_CENTER);
          it.image(halfscreenwidth - 30, halfscreenheight + 70, temp_target_icon, ImageAlign::TOP_CENTER);

          // Display temperature arc circle
          it
            .filled_circle(
              halfscreenwidth + (halfscreenwidth - 10) * cos((90 + startAngle) * id(pi).state / 180),
              halfscreenheight + (halfscreenheight - 10) * sin((90 + startAngle) * id(pi).state / 180), 
              5, 
              id(my_light_yellow));
          it
            .filled_circle(
              halfscreenwidth + (halfscreenwidth - 10) * cos((90 + startAngle + endAngle) * id(pi).state / 180),
              halfscreenheight + (halfscreenheight - 10) * sin((90 + startAngle + endAngle) * id(pi).state / 180), 
              5, 
              id(very_dark_grey));

          for (int i = startAngle; i <= startAngle + firstStepAngle; i++) {
            it
              .filled_triangle(
                halfscreenwidth + (halfscreenwidth - 15) * cos((90 + i) * id(pi).state / 180),
                halfscreenheight + (halfscreenheight - 15) * sin((90 + i) * id(pi).state / 180), 
                halfscreenwidth + (halfscreenwidth - 5) * cos((90 + i) * id(pi).state / 180), 
                halfscreenheight + (halfscreenheight - 5) * sin((90 + i) * id(pi).state / 180), 
                halfscreenwidth + (halfscreenwidth - 5) * cos((90 + (i + 1)) * id(pi).state / 180), 
                halfscreenheight + (halfscreenheight - 5) * sin((90 + (i + 1)) * id(pi).state / 180), 
                id(my_light_yellow));
            it
              .filled_triangle(
                halfscreenwidth + (halfscreenwidth - 15) * cos((90 + i) * id(pi).state / 180),
                halfscreenheight + (halfscreenheight - 15) * sin((90 + i) * id(pi).state / 180), 
                halfscreenwidth + (halfscreenwidth - 5) * cos((90 + (i + 1)) * id(pi).state / 180), 
                halfscreenheight + (halfscreenheight - 5) * sin((90 + (i + 1)) * id(pi).state / 180), 
                halfscreenwidth + (halfscreenwidth - 15) * cos((90 + (i + 1)) * id(pi).state / 180),
                halfscreenheight + (halfscreenheight - 15) * sin((90 + (i + 1)) * id(pi).state / 180), 
                id(my_light_yellow));
          }
          for (int i = startAngle + firstStepAngle; i <= startAngle + secondStepAngle; i++) {
            it
              .filled_triangle(
                halfscreenwidth + (halfscreenwidth - 15) * cos((90 + i) * id(pi).state / 180),
                halfscreenheight + (halfscreenheight - 15) * sin((90 + i) * id(pi).state / 180), 
                halfscreenwidth + (halfscreenwidth - 5) * cos((90 + i) * id(pi).state / 180), 
                halfscreenheight + (halfscreenheight - 5) * sin((90 + i) * id(pi).state / 180), 
                halfscreenwidth + (halfscreenwidth - 5) * cos((90 + (i + 1)) * id(pi).state / 180), 
                halfscreenheight + (halfscreenheight - 5) * sin((90 + (i + 1)) * id(pi).state / 180), 
                id(my_white));
            it
              .filled_triangle(
                halfscreenwidth + (halfscreenwidth - 15) * cos((90 + i) * id(pi).state / 180),
                halfscreenheight + (halfscreenheight - 15) * sin((90 + i) * id(pi).state / 180), 
                halfscreenwidth + (halfscreenwidth - 5) * cos((90 + (i + 1)) * id(pi).state / 180), 
                halfscreenheight + (halfscreenheight - 5) * sin((90 + (i + 1)) * id(pi).state / 180), 
                halfscreenwidth + (halfscreenwidth - 15) * cos((90 + (i + 1)) * id(pi).state / 180),
                halfscreenheight + (halfscreenheight - 15) * sin((90 + (i + 1)) * id(pi).state / 180), 
                id(my_white));
          }
          for (int i = startAngle + secondStepAngle; i <= startAngle + endAngle; i++) {
            it
              .filled_triangle(
                halfscreenwidth + (halfscreenwidth - 15) * cos((90 + i) * id(pi).state / 180),
                halfscreenheight + (halfscreenheight - 15) * sin((90 + i) * id(pi).state / 180), 
                halfscreenwidth + (halfscreenwidth - 5) * cos((90 + i) * id(pi).state / 180), 
                halfscreenheight + (halfscreenheight - 5) * sin((90 + i) * id(pi).state / 180), 
                halfscreenwidth + (halfscreenwidth - 5) * cos((90 + (i + 1)) * id(pi).state / 180), 
                halfscreenheight + (halfscreenheight - 5) * sin((90 + (i + 1)) * id(pi).state / 180), 
                id(very_dark_grey));
            it
              .filled_triangle(
                halfscreenwidth + (halfscreenwidth - 15) * cos((90 + i) * id(pi).state / 180),
                halfscreenheight + (halfscreenheight - 15) * sin((90 + i) * id(pi).state / 180), 
                halfscreenwidth + (halfscreenwidth - 5) * cos((90 + (i + 1)) * id(pi).state / 180), 
                halfscreenheight + (halfscreenheight - 5) * sin((90 + (i + 1)) * id(pi).state / 180), 
                halfscreenwidth + (halfscreenwidth - 15) * cos((90 + (i + 1)) * id(pi).state / 180),
                halfscreenheight + (halfscreenheight - 15) * sin((90 + (i + 1)) * id(pi).state / 180), 
                id(very_dark_grey));
          }

          // Current temperature round
          it
            .filled_circle(
              halfscreenwidth + (halfscreenwidth - 10) * cos((90 + startAngle + currentTemperatureCircleAngle) * id(pi).state / 180),
              halfscreenheight + (halfscreenheight - 10) * sin((90 + startAngle + currentTemperatureCircleAngle) * id(pi).state / 180), 
              3, 
              id(my_white));

          // Start of the second step
          if (firstStepAngle < secondStepAngle) {
            it
              .filled_circle(
                halfscreenwidth + (halfscreenwidth - 10) * cos((90 + startAngle + firstStepAngle) * id(pi).state / 180),
                halfscreenheight + (halfscreenheight - 10) * sin((90 + startAngle + firstStepAngle) * id(pi).state / 180), 
                5, 
                id(my_white));
            it
              .filled_circle(
                halfscreenwidth + (halfscreenwidth - 10) * cos((90 + startAngle + firstStepAngle) * id(pi).state / 180),
                halfscreenheight + (halfscreenheight - 10) * sin((90 + startAngle + firstStepAngle) * id(pi).state / 180), 
                2, 
                id(very_dark_grey));
          } 

          // Target temperature round
          it
            .filled_circle(
              halfscreenwidth + (halfscreenwidth - 10) * cos((90 + startAngle + targetTemperatureCircleAngle) * id(pi).state / 180),
              halfscreenheight + (halfscreenheight - 10) * sin((90 + startAngle + targetTemperatureCircleAngle) * id(pi).state / 180), 
              7, 
              id(very_dark_grey));
          it
            .filled_circle(
              halfscreenwidth + (halfscreenwidth - 10) * cos((90 + startAngle + targetTemperatureCircleAngle) * id(pi).state / 180),
              halfscreenheight + (halfscreenheight - 10) * sin((90 + startAngle + targetTemperatureCircleAngle) * id(pi).state / 180), 
              5, 
              id(my_white));

    - id: ClimateSettingsPage
      lambda: |- 
        Color default_circle_color = id(very_dark_blue);

        Color heat_on = default_circle_color;
        Color cool_on = default_circle_color;
        Color dry_on = default_circle_color;
        Color auto_on = default_circle_color;
        Color fan_on = default_circle_color;
        Color power_off = default_circle_color;


        float screenheight = it.get_height();
        float screenwidth = it.get_width();
        float halfscreenheight = screenheight / 2;
        float halfscreenwidth = screenwidth / 2;

        it.image(120, 120, background, ImageAlign::CENTER);

        if (id(climatedevice).state == "cool")
        {
            // cooling
            cool_on = my_light_blue;
        }
        else if (id(climatedevice).state == "heat")
        {
            // heating
            heat_on = my_light_red;
        }
        else if (id(climatedevice).state == "auto")
        { 
            // auto heat or cool
            auto_on = my_light_orange;
        }
        else if (id(climatedevice).state == "fan_only")
        {
            // fan only
            fan_on =  my_light_orange;
        }
        else if (id(climatedevice).state == "dry")
        {
            // dry
            dry_on = my_green;
        }
        else
        {
          power_off = my_light_blue;
        }

        it.filled_circle(55, 85, 30, auto_on);  // Circle 5
        it.image(55, 85, ac_heatcool_40, ImageAlign::CENTER);

        it.filled_circle(120, 85, 30, cool_on);  // Circle 4
        it.image(120, 85, ac_cool_40, ImageAlign::CENTER);

        it.filled_circle(185, 85, 30, heat_on);  // Circle 2
        it.image(185, 85, ac_heat_40, ImageAlign::CENTER);

        it.filled_circle(55, 155, 30, dry_on);  // Circle 3
        it.image(55, 155, ac_dry_40, ImageAlign::CENTER);

        it.filled_circle(120, 155, 30, fan_on);   // Circle 6
        it.image(120, 155, fan_menu_icon, ImageAlign::CENTER);

        it.filled_circle(185, 155, 30, power_off);  // Central Circle
        it.image(185, 155, powercycle, ImageAlign::CENTER);

qr_code:
  - id: homepage_qr
    value: esphome.io

binary_sensor:
  - platform: touchscreen
    name: "Central Circle Touch"
    x_min: 90   # Center x - radius
    x_max: 150  # Center x + radius
    y_min: 90   # Center y - radius
    y_max: 150  # Center y + radius
    page_id: TestPage
    on_press:
      - display.page.show: FirstPage
  - platform: touchscreen
    name: "Circle 2 Touch"
    x_min: 160  # Center x - radius
    x_max: 220  # Center x + radius
    y_min: 90   # Center y - radius
    y_max: 150  # Center y + radius
    page_id: TestPage
    on_press:
      then:
        - logger.log: "Circle 2 Touched"
  - platform: touchscreen
    name: "Circle 3 Touch"
    x_min: 125  # Center x - radius
    x_max: 185  # Center x + radius
    y_min: 151  # Center y - radius
    y_max: 211  # Center y + radius
    page_id: TestPage
    on_press:
      - display.page.show: WifiQR
  - platform: touchscreen
    name: "Circle 4 Touch"
    page_id: TestPage
    x_min: 55   # Center x - radius
    x_max: 115  # Center x + radius
    y_min: 151  # Center y - radius
    y_max: 211  # Center y + radius
    on_press:
      then:
        - logger.log: "Circle 4 Touched"
  - platform: touchscreen
    name: "Circle 5 Touch"
    page_id: TestPage
    x_min: 20   # Center x - radius
    x_max: 80   # Center x + radius
    y_min: 90   # Center y - radius
    y_max: 150  # Center y + radius
    on_press:
      then:
        - logger.log: "Circle 5 Touched"
  - platform: touchscreen
    name: "Circle 6 Touch"
    page_id: TestPage
    x_min: 55   # Center x - radius
    x_max: 115  # Center x + radius
    y_min: 29   # Center y - radius
    y_max: 89   # Center y + radius
    on_press:
      - delay: 15ms
      - display.page.show: AirConPage
  - platform: touchscreen
    name: "Circle 7 Touch"
    page_id: TestPage
    x_min: 125  # Center x - radius
    x_max: 185  # Center x + radius
    y_min: 29   # Center y - radius
    y_max: 89   # Center y + radius
    on_press:
      then:
        - logger.log: "Circle 7 Touched"
  - platform: touchscreen
    name: "LightPowerTouch"
    page_id: FirstPage
    x_min: 0  # Center x - radius
    x_max: 240  # Center x + radius
    y_min: 0   # Center y - radius
    y_max: 240   # Center y + radius
    on_press:
      then:
        - logger.log: "Light Power Touched"
        - homeassistant.service:
                service: light.toggle
                data:
                  entity_id: light.great_room_dimmer_4
  - platform: touchscreen
    name: "ClimateSelection"   
    x_min: 0  # Center x - radius
    x_max: 240  # Center x + radius
    y_min: 0   # Center y - radius
    y_max: 240   # Center y + radius
    page_id: AirConPage
    on_press:
      - display.page.show: ClimateSettingsPage
  
  - platform: touchscreen
    name: "Climate Auto Touch"
    x_min: 40   # Center x - radius
    x_max: 70  # Center x + radius
    y_min: 60  # Center y - radius
    y_max: 100  # Center y + radius
    page_id: ClimateSettingsPage
    on_press:
      - homeassistant.service:
          service: climate.set_hvac_mode
          data:
            entity_id: climate.doris
            hvac_mode: "heat_cool"
      - component.update: my_lcd
  
  - platform: touchscreen
    name: "Climate Cool Touch"
    x_min: 105   # Center x - radius
    x_max: 135  # Center x + radius
    y_min: 60  # Center y - radius
    y_max: 100  # Center y + radius
    page_id: ClimateSettingsPage
    on_press:
      - homeassistant.service:
          service: climate.set_hvac_mode
          data:
            entity_id: climate.doris
            hvac_mode: "cool"
      - component.update: my_lcd
  
  - platform: touchscreen
    name: "Climate Heat Touch"
    x_min: 170   # Center x - radius
    x_max: 200  # Center x + radius
    y_min: 60  # Center y - radius
    y_max: 100  # Center y + radius
    page_id: ClimateSettingsPage
    on_press:
      - homeassistant.service:
          service: climate.set_hvac_mode
          data:
            entity_id: climate.doris
            hvac_mode: "heat"
      - component.update: my_lcd

  - platform: touchscreen
    name: "Climate Power Off Touch"
    x_min: 160   # Center x - radius
    x_max: 200  # Center x + radius
    y_min: 140  # Center y - radius
    y_max: 170  # Center y + radius
    page_id: ClimateSettingsPage
    on_press:
      - homeassistant.service:
          service: climate.set_hvac_mode
          data:
            entity_id: climate.doris
            hvac_mode: "off"
      - component.update: my_lcd

  - platform: gpio
    pin: GPIO42
    name: "BacklightButton" 
    on_press:
      - if:
          condition:
            display.is_displaying_page: ClimateSettingsPage
          then:
            - display.page.show: AirConPage
          else:
            - display.page.show: TestPage

  - platform: ld2410
    has_target:
      name: Presence
    has_moving_target:
      name: Moving Target
    has_still_target:
      name: Still Target

sensor:
  - platform: homeassistant
    id: climate_target_temperature
    entity_id: climate.doris
    attribute: temperature
    on_value:
      then:
        - component.update: my_lcd

  - platform: homeassistant
    id: climate_new_temperature
    entity_id: climate.doris
    attribute: temperature
    on_value:
      if:
        condition:
          not:
            - script.is_running: my_climate_temperature_script
        then:
            - lambda: 'id(temperature_new_setpoint).publish_state(x);'
            - component.update: my_lcd

  - platform: homeassistant
    id: climate_current_temperature
    entity_id: climate.doris
    attribute: current_temperature
    on_value:
      then:
        - component.update: my_lcd

  - platform: homeassistant
    id: climate_min_temperature
    entity_id: climate.doris
    attribute: min_temp
    on_value:
      then:
        - component.update: my_lcd

  - platform: homeassistant
    id: climate_max_temperature
    entity_id: climate.doris
    attribute: max_temp
    on_value:
      then:
        - component.update: my_lcd

  - platform: rotary_encoder
    name: "Rotary Encoder"
    id: rotaryencoder
    resolution: 1
    pin_a: 
      number: GPIO40
      mode:
       input: true
       pullup: true
    pin_b: 
      number: GPIO41
      mode:
       input: true
       pullup: true
    accuracy_decimals: 1
    on_clockwise:
      - if:
          condition:
            - display.is_displaying_page: AirConPage
          then:
            - lambda: 'id(temperature_new_setpoint).publish_state(id(temperature_new_setpoint).state + 1);'
            - component.update: my_lcd 
            - script.execute: my_climate_temperature_script
                      
      - if:
          condition:
            - display.is_displaying_page: FirstPage
          then:
            - lambda: |-
                int newvalue = id(new_light_brightness).state;
                if (newvalue > 229) {
                  id(new_light_brightness).publish_state(254); }
                else {
                  id(new_light_brightness).publish_state(id(new_light_brightness).state + 10); }
            - component.update: my_lcd
            - script.execute: my_light_brightness_script
            
            
    on_anticlockwise:
      - if:
          condition:
            - display.is_displaying_page: AirConPage
          then:
            - lambda: 'id(temperature_new_setpoint).publish_state(id(temperature_new_setpoint).state - 1);'
            - script.execute: my_climate_temperature_script
            - component.update: my_lcd
            
      - if:
          condition:
            - display.is_displaying_page: FirstPage
          then:
            - lambda: |-
                int newvalue = id(new_light_brightness).state;
                if (newvalue < 26) {
                  id(new_light_brightness).publish_state(0); }
                else {
                  id(new_light_brightness).publish_state(id(new_light_brightness).state - 10); }
            - script.execute: my_light_brightness_script
            - component.update: my_lcd
            
            

  - platform: homeassistant
    name: "Media Volume"
    id: "beam_volume"
    entity_id: media_player.living_room
    attribute: volume_level
  - platform: ld2410
    detection_distance:
      name: Detection Distance
      id: ddistance
      filters:
        - throttle: 0.5s
      on_value: 
        then:
          if:
            condition:
              - lambda: 'return id(ddistance).state < 150;'  
            then:
              if:
                condition:
                  - light.is_off: backlight
                then:              
                  - light.turn_on: backlight
            else:
              - light.turn_off: 
                  id: backlight
                  transition_length: 1s           
    light:
      name: light
    moving_distance:
      name : Moving Distance
    still_distance:
      name: Still Distance
    moving_energy:
      name: Move Energy
    still_energy:
      name: Still Energy

  - platform: homeassistant
    name: "Dimmer Light Brightness"
    id: "dimmersensor_brightness"
    entity_id: light.great_room_dimmer_4
    attribute: brightness
    on_value:
      if:
        condition:
          not:
            - script.is_running: my_light_brightness_script
        then:
          - lambda: 'id(new_light_brightness).publish_state(x);'
          - component.update: my_lcd

  - platform: homeassistant
    name: "Climate Device Current Temperature"
    id: "climatedevice_currenttemp"
    entity_id: climate.doris
    attribute: current_temperature
    on_value:
      - component.update: my_lcd
     
  - platform: homeassistant
    name: "Climate Device Setpoint"
    id: "climatedevice_setpoint"
    entity_id: climate.doris
    attribute: temperature
    on_value:
       if:
        condition:
          not:
            - script.is_running: my_climate_temperature_script
        then:
            - lambda: 'id(temperature_new_setpoint).publish_state(x);'
            - component.update: my_lcd

  - platform: homeassistant
    name: "Room Lux Sensor"
    id: luxsensor
    entity_id: sensor.sauron_illuminance
    on_value:
      - logger.log: 
          format: "The illumincance sensor reports value %.0f"
          args: [ 'id(luxsensor).state' ]
      - lambda: |- 
          float lux = id(luxsensor).state;
          if (lux < 15) 
          { 
            id(oledbacklight).set_level(0.1);
          }
          else if (lux < 50)
          {
            id(oledbacklight).set_level(0.3);
          }
          else if (lux < 125)
          {
            id(oledbacklight).set_level(0.5);
          }
          else if (lux < 200)
          {
            id(oledbacklight).set_level(0.6);
          }
          else
          {
            id(oledbacklight).set_level(1);
          }

light:
  - platform: monochromatic
    id: backlight
    name: "Backlight"
    output: oledbacklight
    default_transition_length: 250ms

output:
  - id: oledbacklight
    platform: ledc
    pin: GPIO9
    max_power: 1
    min_power: 0
  - platform: ledc
    pin: GPIO3
    id: my_speaker_output
    
switch:
  - platform: ld2410
    engineering_mode:
      name: "engineering mode"
    bluetooth:
      name: "control bluetooth"

text_sensor:
  - platform: ld2410
    version:
      name: "firmware version"
    mac_address:
      name: "mac address"
  - platform: homeassistant
    name: "Dimmer Light Sensor"
    id: "dimmersensor"
    entity_id: light.great_room_dimmer_4
    filters:
      - to_upper:
  - platform: homeassistant
    name: "Climate Device"
    id: "climatedevice"
    entity_id: climate.doris
    filters:
    - map:
      - heat_cool -> auto
  - platform: homeassistant
    name: "Media Player Mute"
    id: "mediaplayermute"
    entity_id: media_player.living_room
    attribute: is_volume_muted
  - platform: homeassistant
    name: "Zones Open"
    id: "zones_open"
    entity_id: sensor.ac_zones_open
  - platform: template
    name: "RTC Sensor"
    id: template_text
  - platform: wifi_info
    ip_address:
      name: ESP IP Address
      id: espip
    
    
